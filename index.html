<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Calculateur APR Funding Hyperliquid & Aster</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style> table { border-collapse: collapse; width: 100%; } th, td { border: 1px solid #ddd; padding: 8px; } </style>
</head>
<body>
    <h2>Tableau Interactif Funding Rates & APR Net</h2>
    <label>Position Size (USDC): <input type="number" id="size" value="10000"></label>
    <label>Levier: <input type="number" id="levier" value="10"></label>
    <label>Side: <select id="side"><option value="long">Long</option><option value="short">Short</option></select></label>
    <button onclick="updateTable()">Mettre à Jour</button>
    <button onclick="loadSimulatedData()">Charger Données Simulées</button>
    <table id="fundingTable">
        <thead><tr><th>Paire</th><th>Exchange</th><th>Funding Rate (%/période)</th><th>Spread (%)</th><th>Rendement Net / Funding (USDC)</th><th>APR Net Annuel (%)</th></tr></thead>
        <tbody></tbody>
    </table>
    <canvas id="aprChart" width="400" height="200"></canvas>

    <script>
        // Données simulées basées sur tendances 30/09/2025
        const simulatedData = [
            { pair: 'BTC', exchange: 'Hyperliquid', funding: 0.0125, spread: 0.005 },
            { pair: 'ETH', exchange: 'Hyperliquid', funding: 0.0417, spread: 0.008 },
            { pair: 'SOL', exchange: 'Hyperliquid', funding: 0.0200, spread: 0.010 },
            { pair: 'AVAX', exchange: 'Hyperliquid', funding: 0.0150, spread: 0.007 },
            { pair: 'LINK', exchange: 'Hyperliquid', funding: 0.0180, spread: 0.012 },
            { pair: 'BTC', exchange: 'Aster', funding: 0.0100, spread: 0.020 },
            { pair: 'ETH', exchange: 'Aster', funding: 0.0150, spread: 0.025 },
            { pair: 'SOL', exchange: 'Aster', funding: 0.0120, spread: 0.015 },
            { pair: 'DOGE', exchange: 'Aster', funding: 0.0080, spread: 0.030 },
            { pair: 'ADA', exchange: 'Aster', funding: 0.0110, spread: 0.018 }
        ];

        async function fetchHyperliquidData() {
            try {
                const response = await fetch('https://api.hyperliquid.xyz/info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'metaAndAssetCtxs' })
                });
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                const topAssets = data.universe[1].slice(0, 5).map(ctx => ({
                    pair: data.universe[0][ctx[0]],
                    exchange: 'Hyperliquid',
                    funding: parseFloat(ctx[1].funding) * 100,
                    spread: ((parseFloat(ctx[1].impactPxs[0]) - parseFloat(ctx[1].impactPxs[1])) / parseFloat(ctx[1].markPx)) * 100
                }));
                return topAssets;
            } catch (error) {
                console.error('CORS/API Error:', error);
                alert('API Hyperliquid bloquée par CORS. Clique "Charger Données Simulées" pour tester.');
                return [];
            }
        }

        async function fetchAsterData() {
            return simulatedData.filter(d => d.exchange === 'Aster').slice(0, 5);
        }

        function calculateYield(fundingRate, size, levier, side, spread, isHyper = true) {
            const periodHours = isHyper ? 1 : 8;
            const value = size * levier;
            const sign = (side === 'long' && fundingRate > 0) || (side === 'short' && fundingRate < 0) ? 1 : -1;
            const netPerFunding = sign * fundingRate / 100 * value - (spread / 100 * value);
            const annual = netPerFunding * (8760 / periodHours) / size;
            return { netPerFunding: netPerFunding.toFixed(2), apr: annual.toFixed(2) };
        }

        async function updateTable(useSimulated = false) {
            const size = parseFloat(document.getElementById('size').value);
            const levier = parseFloat(document.getElementById('levier').value);
            const side = document.getElementById('side').value;
            let allData = [];

            if (useSimulated) {
                allData = simulatedData;
            } else {
                const hyperData = await fetchHyperliquidData();
                const asterData = await fetchAsterData();
                allData = [...hyperData, ...asterData];
                if (allData.length === 0) {
                    loadSimulatedData();
                    return;
                }
            }

            let tableBody = '';
            const labels = [], aprs = [];
            allData.slice(0, 10).forEach(row => {
                const calcs = calculateYield(row.funding, size, levier, side, row.spread, row.exchange === 'Hyperliquid');
                tableBody += `<tr><td>${row.pair}</td><td>${row.exchange}</td><td>${row.funding.toFixed(4)} ${row.exchange === 'Aster' ? '(/8h)' : '(/1h)'}</td><td>${row.spread.toFixed(4)}</td><td>${calcs.netPerFunding}</td><td>${calcs.apr}</td></tr>`;
                labels.push(row.pair + ' (' + row.exchange + ')');
                aprs.push(parseFloat(calcs.apr));
            });
            document.querySelector('#fundingTable tbody').innerHTML = tableBody;

            const ctx = document.getElementById('aprChart').getContext('2d');
            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'APR Net (%)', data: aprs, backgroundColor: aprs.map(a => a > 0 ? 'green' : 'red') }] },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        function loadSimulatedData() {
            updateTable(true);
        }

        updateTable(true);
    </script>
</body>
</html>Mise à jour index.html avec données simulée

